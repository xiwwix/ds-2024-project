<div id="query-content">
    <h3>关键人物分析</h3>
    <button id="degree-btn">度中心性</button>
    <button id="betweenness-btn">介数中心性</button>
    <button id="cut-vertex-btn">割点</button>
</div>
<div id="result-content">
    <h3>分析结果</h3>
    <div id="result">在此显示分析结果</div>
</div>

<!-- 引入分析算法 -->
<script src="functions/degree_centrality.js"></script>
<script src="functions/betweenness_centrality.js"></script>
<script src="functions/cut_vertex.js"></script>

<script>
    console.log("key_person.html loaded"); // 确认 HTML 文件加载成功

    // 通用更新函数（度中心性和介数中心性）
    function updateVisualization(result, graphData, type) {
        console.log(`Updating visualization with ${type} centrality...`);

        // 获取 Cytoscape 实例
        const cy = window.cy;

        // 获取最大中心性值
        const maxCentrality = Math.max(...result.map(node => node.centrality || node.degree || 0));
        console.log(`Max centrality for ${type}:`, maxCentrality);

        cy.nodes().forEach(node => {
            const id = node.id();
            const centralityNode = result.find(n => n.id === id);

            if (centralityNode) {
                const value = centralityNode.centrality || centralityNode.degree || 0;
                const label = centralityNode.label || node.data('label');

                // 更新样式和标签
                updateNodeStyle(node, value, maxCentrality, type);
                node.style('label', `${label} (${value.toFixed(2)})`); // 显示数值
            } else {
                // 如果找不到对应节点，默认设置为 0
                updateNodeStyle(node, 0, maxCentrality, type);
                node.style('label', `${node.data('label')} (0.00)`);
            }
        });

        // 显示分析结果
        document.getElementById('result').innerHTML = `
            分析完成！节点按照${type === 'degree' ? '度中心性' : '介数中心性'}排序如下：<br/>
            ${result.map(n => `${n.label}: ${(n.centrality?.toFixed(2) || n.degree)}`).join('<br/>')}
        `;
    }

    // 通用节点样式更新函数
    function updateNodeStyle(node, value, max, type) {
        let color;
        let borderColor = 'transparent'; // 默认边框透明

        // 根据分析类型设置颜色渐变
        if (type === 'degree') {
            // 蓝色渐变（度中心性）
            const intensity = 1 - value / max;
            color = `rgb(${Math.floor(255 * intensity)}, ${Math.floor(255 * intensity)}, 255)`;
        } else if (type === 'betweenness') {
            // 红色渐变（介数中心性）
            const intensity = 1 - value / max;
            color = `rgb(255, ${Math.floor(255 * intensity)}, ${Math.floor(255 * intensity)})`;
        }

        // 特判中心性为 0 的节点
        if (value === 0) {
            color = 'grey'; // 背景灰色
        }

        // 应用样式
        node.style({
            'background-color': color,
            'border-color': borderColor
        });
    }

    // 清除所有节点的标签
    function clearNodeLabels() {
        const cy = window.cy;
        cy.nodes().forEach(node => {
            node.style('label', ''); // 清除标签
        });
    }

    (function () {
        console.log("Initialization code running (key_person.html)");

        // 获取全局 graphData
        const graphData = window.graphData;
        console.log("Graph Data:", graphData);

        if (!graphData || !graphData.nodes || !graphData.edges) {
            console.error('Graph Data is not available:', graphData);
            document.getElementById('result').innerHTML = '图数据尚未加载，请返回上传数据。';
            return;
        }

        const cy = window.cy; // 获取 Cytoscape 实例

        // 度中心性按钮点击事件
        document.getElementById('degree-btn').addEventListener('click', () => {
            console.log("Degree centrality button clicked");

            const result = DegreeCentrality(graphData);
            console.log("Degree Centrality Result:", result);

            updateVisualization(result, graphData, 'degree');
        });

        // 介数中心性按钮点击事件
        document.getElementById('betweenness-btn').addEventListener('click', () => {
            console.log("Betweenness centrality button clicked");

            const result = BetweennessCentrality(graphData);
            console.log("Betweenness Centrality Result:", result);

            updateVisualization(result, graphData, 'betweenness');
        });

        // 割点按钮点击事件
        document.getElementById('cut-vertex-btn').addEventListener('click', () => {
            console.log("Cut vertex button clicked");

            // 清除标签
            clearNodeLabels();

            const result = CutVertex(graphData);
            console.log("Cut Vertex Result:", result);

            const cutVertexLabels = result.map(id => {
                const node = graphData.nodes.find(n => n.data.id === id);
                return node ? node.data.label : id; // 返回人名或 ID
            });
            console.log("Cut Vertex Labels:", cutVertexLabels);

            updateVisualizationWithCutVertex(result, cutVertexLabels, graphData);
        });

        // 更新可视化界面：割点分析
        function updateVisualizationWithCutVertex(result, labels, graphData) {
            console.log("Updating visualization with cut vertex...");

            cy.nodes().forEach(node => {
                const id = node.id();
                const isCutVertex = result.includes(id);

                let color = isCutVertex ? 'yellow' : 'grey';
                // let borderColor = isCutVertex ? 'black' : 'grey';

                node.style({
                    'background-color': color,
                    // 'border-color': borderColor
                });
            });

            document.getElementById('result').innerHTML = `
                分析完成！割点如下：<br/>
                ${labels.join(', ')}
            `;
        }
    })();
</script>
